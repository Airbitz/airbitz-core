# Common variables
download_dir=$base_dir/download

# Common tasks

# Downloads all the source files mentioned in $source
download() {
    mkdir -p $download_dir
    for s in $source; do
        filename="$download_dir/$(echo $s | sed -e's@^.*/@@' -e's@\?.*$@@')"
        if [ $filename != ${filename%.git} ]; then
            if [ -e $filename ]; then
                git --git-dir="$filename" fetch -f "$s" master:master
            else
                git clone --bare "$s" "$filename"
            fi
        else
            [ -e $filename ] || wget -O "$filename" "$s"
        fi
    done
}
task download

# Unpacks the source files mentioned in $source with the .tar.* extension
unpack() {
    for s in $source; do
        filename="$download_dir/$(echo $s | sed -e's@^.*/@@' -e's@\?.*$@@')"
        if echo $filename | grep -q -e'\.tar.*$' -e'\.tgz$'; then
            echo "Unpacking $(relative $filename) to $(relative $work_dir)..."
            tar -C $work_dir -xf $filename
        elif [ $filename != ${filename%.git} ]; then
            git --git-dir="$filename" --work-tree="$work_dir" reset --hard master
        fi
    done
}
task unpack download

clean() {
    rm -rf $work_dir
}
task clean
